---
layout: "@layouts/MarkdownPostLayout.astro"
title: ä¸€é“è°ƒç”¨å †æ ˆçš„æ€§èƒ½ä¼˜åŒ–é¢˜
author: J10c
pubDate: 2022-11-04
tags: ["programming"]
---

æ˜¨å¤©å‚åŠ äº†ä¸€åœºæ€§èƒ½ä¼˜åŒ–çš„æ¯”èµ›ï¼Œé¢˜ç›®å¾ˆç®€å•ï¼Œä¼˜åŒ–æ€è·¯æ˜¯ä¼˜åŒ–å †æ ˆè°ƒç”¨ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡å†™è¿™ç§é¢˜ç›®ï¼Œæ²¡å‘æŒ¥å‡ºæ¥ğŸ˜µ

èµ›åæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œåœ¨æˆ‘ä»£ç çš„åŸºç¡€ä¸Šï¼Œå¤§æ¦‚æœ‰ä¸¤ç§ä¸åŒç¨‹åº¦çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œä½†æ˜¯è¿™ç¯‡æ–‡ç« å†™ç€å†™ç€ï¼Œå‘ç°å †æ ˆè°ƒç”¨æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å‘

é¡ºä¾¿æä¸€ä¸‹ï¼ŒACEçš„è€—æ—¶æ˜¯æˆ‘ï¼ˆç¬¬äº”ï¼‰çš„ä¸€åŠ

## åŸé¢˜

æœ‰åˆ æ”¹ï¼Œä½†æ˜¯é¢˜æ„ä¸å˜

```cpp
struct vec {
  int *data;
  int length;
};

void get_vec_element(vec *v, int index, int *data) {
  int value;
  value = v->data[index];
  *data = value;
}

int get_vec_length(vec *v) { return v->length; }

/*
  v->data = {1, 2, 3, 4, 5}
  sum = 1 + 2 + 3 + 4 + 5 = 15
*/
void combine(vec *v, int *dest) {
  // code here
  int i;

  *dest = 0;
  for (i = 0; i < get_vec_length(v); i++) {
    int val;
    get_vec_element(v, i, &val);
    *dest = *dest + val;
  }
}

int main() {
  vec v;
  v.data = new int[5]{1, 2, 3, 4, 5};
  v.length = 5;
  int sum = 0;

  for (int i = 0; i < 100000000; i++) {
	// æ”¾å¤§å·®å¼‚
    sum = 0;
    combine(&v, &sum);
  }

  delete[] v.data;

  return 0;
}
```

## çº¦å®š

æˆ‘åœ¨åŸé¢˜çš„åŸºç¡€ä¸Šï¼Œåœ¨forå¾ªç¯çš„ä¸Šä¸‹å†™äº†å®šæ—¶å™¨ï¼Œæµ‹å‡ºforå¾ªç¯ç»“æŸçš„è€—æ—¶ï¼Œä»è€Œæ¯”è¾ƒæ€§èƒ½

### è¿è¡Œç¯å¢ƒ

```
Compiler: clang++@13.1.6
Build Tool: cmake@3.24.3
CPU: Apple M2
OS: macOS 12.4 21F2081 arm64
```

## åˆ†æ

- `data`æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å †åŒºçš„ä¸€ä¸ªæ•°ç»„
- `get_vec_length()`é—´æ¥è®¿é—®**ä¸€æ¬¡**
- `get_vec_element()`è¿™ä¸ªå‡½æ•°å¼€é”€å¤ªå¤§äº†ï¼Œè·å–æ•°ç»„ä¸€ä¸ªå…ƒç´ ï¼Œè®¿é—®å †åŒºï¼Œåˆé€šè¿‡æŒ‡é’ˆè®¿é—®æ ˆåŒºçš„å†…å­˜ï¼Œä¸€å…±**ä¸¤æ¬¡**é—´æ¥è®¿é—®
- `combine`è¿™ä¸ªå‡½æ•°ä¸­è¿˜æœ‰ä¸€ä¸ªç´¯åŠ è¯­å¥ï¼Œ**ä¸¤æ¬¡**é—´æ¥è®¿é—®
- ç®—ä¸‹æ¥ä¸€æ¬¡å¾ªç¯éœ€è¦**äº”æ¬¡**é—´æ¥è®¿é—®ï¼ˆå¾ªç¯å¤–çš„ä¸è®¡ç®—åœ¨å†…ï¼‰

## ç­”æ¡ˆ

### Case1

èµ›åœºçš„æ—¶å€™æƒ³å‡ºæ¥çš„ï¼Œå½“æ—¶çœ‹æå‡å¹…åº¦æŒºå¤§çš„å°±ç›´æ¥äº¤äº†

`for`çš„**æ¯ä¸€æ¬¡å¾ªç¯**éƒ½ä¼šè®¡ç®—ç»ˆæ­¢æ¡ä»¶ï¼Œå³è°ƒç”¨`get_vec_length()`

> ä¸¤æ¬¡é—´æ¥è®¿é—® + ä¸€æ¬¡å‡½æ•°è°ƒç”¨å¼€é”€

```cpp
// 109ms
void combine(vec *v, int *dest) {
  int i;

  int sum = 0;
  for (i = 0; i < get_vec_length(v); i++) {
    sum += v->data[i];
  }

  *dest = sum;
}
```

### Case2

æœ‹å‹çš„ç­”æ¡ˆï¼Œä¼˜åŒ–äº†ä¸€ä¸ªå‡½æ•°è°ƒç”¨

ç´¯åŠ å…¨åœ¨æ ˆåŒºæ“ä½œï¼Œä¸€æ¬¡`for`å¾ªç¯å†…è®¿é—®ä¸€æ¬¡å †åŒºï¼Œæœ€åä¸€æ­¥æŠŠæ•°å€¼èµ‹ç»™å †åŒº

```cpp
// 78ms
void combine2(vec *v, int *dest) {
  int i;
  int len = get_vec_length(v);

  int sum = 0;
  for (i = 0; i < len; i++) {
    sum += v->data[i];
  }

  *dest = sum;
}
```

### Case3

ç´¯åŠ éƒ½åœ¨å †åŒºæ“ä½œï¼Œæ•ˆç‡æœ€é«˜ï¼Œä½†æ˜¯ä¸è®²æ­¦å¾·ï¼ŒæŠŠåŸæ•°ç»„æ”¹äº†

```cpp
// 69ms
void combine3_0(vec *v, int *dest) {
  int i;
  int len = get_vec_length(v);

  for (i = 1; i < len; i++) {
    v->data[i] += v->data[i - 1];
  }

  *dest = v->data[i - 1];
}
```

ä¸‹é¢æœ‰ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ä¾‹å­ï¼Œæˆ‘æŠŠç´¯åŠ æ¢äº†ä¸€ç§å†™æ³•

```cpp
// 80ms
void combine3_1(vec *v, int *dest) {
  int i;
  int len = get_vec_length(v);

  for (i = 1; i < len; i++) {
    v->data[i] = v->data[i] + v->data[i - 1];
  }

  *dest = v->data[i - 1];
}
```

å¯ä»¥å‘ç°ä¸¤ç§ç´¯åŠ å†™æ³•å®é™…ä¸Šçš„è°ƒç”¨æ˜¯ä¸ä¸€æ ·çš„ï¼Œä»…åœ¨æ­¤æƒ…å†µä¸‹ï¼ˆå¤šè®¿é—®äº†ä¸€æ¬¡å †å†…å­˜ï¼‰

```cpp
sum += v->data[i];
sum = sum + v->data[i]; // equivalent

v->data[i] += v->data[i - 1]; // 69ms
v->data[i] = v->data[i] + v->data[i - 1]; // 79ms
// time-consumed
```

## æ€»ç»“

å¤§ä½¬çš„å†™æ³•æ²¡å»é—®ï¼Œç°åœºæ˜¯æ¯” case2 è¦å¿«ï¼Œå¯èƒ½æ¯” case3 è¦å¿«ï¼Œè‡ªå·±ä¹Ÿå†™ä¸å‡ºæ¥ï¼Œæ‘†çƒ‚äº†

ç ”ç©¶è¿‡ç¨‹å¤´å¾ˆå¤§ï¼Œ`operator+=`å‡ºç°ä¸ç­‰ä»·çš„ç»“æœï¼Œæˆ‘æƒ³äº†å¥½ä¹…ï¼Œæ²¡æƒ³å‡ºæ¥ä¸ºä»€ä¹ˆã€‚è¿™ä¸ªæ·±ç©¶ä¹Ÿæ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œå®é™…ä½¿ç”¨ä¸­äº§ç”Ÿçš„æ€§èƒ½å·®å¼‚å¾®ä¹å…¶å¾®ã€‚

## åˆ†äº«

å‡å°‘å †æ ˆè°ƒç”¨è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆåœ¨é€’å½’çš„æ—¶å€™ä¹Ÿèƒ½ç”¨ä¸Šï¼Œé€’å½’ä¸æ–­ä¿ç•™ä½œç”¨åŸŸå†…çš„å˜é‡ï¼Œå¯èƒ½å¯¼è‡´æ ˆå†…å­˜æº¢å‡ºï¼Œå°¾é€’å½’å°±èƒ½å¾ˆå¥½åœ°è§£å†³é—®é¢˜

```cpp
int f(int n) { 
  // å‡½æ•°ä¸å›ç«‹å³è¿”å›
  // æ¯æ¬¡è°ƒç”¨çš„ n éƒ½å­˜åœ¨æ ˆä¸­
  return (n == 1) ? 1 : n + f(n - 1); 
}
```

```cpp
int f_tail(int n, int res = 0) {
	// å‚æ•°åœ¨ç»“æŸå‡½æ•°è¿”å›çš„æ—¶å€™å°±è¢«é‡Šæ”¾
	// æ²¡æœ‰ä»»ä½•å˜é‡ç•™åœ¨æ ˆå†…
  return (n == 0) ? res : f_tail(n - 1, res + n);
}
```

